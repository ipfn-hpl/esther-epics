@startuml
' https://plantuml.com/state-diagram
' create png with: $ plantuml starting-low-vacuum-sm.uml
' scale 350 width
hide empty description

state start1  <<start>>
start1 -> Inactive
' [*] -> Inactive

Inactive : Not controlling Instruments
' state Stopped {
'   [*] --> 
'  Idle --> Configuring : powerInst
'  Configuring --> Idle : EvConfig
' }

Inactive -down-> CheckCircuits : State StartingLowVacuum 
state CheckCircuits  {
'  [*] --> NewValueSelection
'  NewValueSelection --> NewValuePreview : EvNewValue
'  NewValuePreview --> NewValueSelection : EvNewValueRejected
'  NewValuePreview --> NewValueSelection : EvNewValueSaved
'  state NewValuePreview {
'     State1 -> State2
'  }
'  --
    [*] -> HidraulicPressureON
    HidraulicPressureON -> WaterCircuitON
    WaterCircuitON -> FansTurbosON
    FansTurbosON ->  [*]
    state HidraulicPressureON #lightblue
    state WaterCircuitON #lightblue
    state FansTurbosON #lightblue
  --
    [*] -> OpenSTDTArm
    state "Open STDT Arm" as OpenSTDTArm
    OpenSTDTArm -> [*]
}

' CheckCircuits -down-> OpenValvesPre : Press(ST)  < 10 mBar
CheckCircuits --> choicePre
state choicePre <<choice>>

choicePre --> OpenValvesPre : [Press(ST)  < 10 mBar]
choicePre --> StartDryPumpDT : [Press(ST)  >= 10 mBar]

state OpenValvesPre  {
'  --
    [*] -> CTSTGateValveOn
    CTSTGateValveOn -> STDTGateValveOn
    STDTGateValveOn -> [*]
}
OpenValvesPre  -right-> CheckValvesPre

state CheckValvesPre { 
    [*] --> checkCTSTGateValve
    state checkCTSTGateValve
}
CheckValvesPre -down-> StartDryPumpDT
CheckValvesPre -up-> start1 : Abort

state StartDryPumpDT {
    [*] --> autoDT
    state autoDT
    ' <<fork>>
    autoDT --> DryPumpDTon : Dry Pump DT Manual
    autoDT -->  [*] 
    state DryPumpDTon

}
StartDryPumpDT -right-> StartDryPumpCT

state StartDryPumpCT  {
    [*] --> autoCT
    state autoCT <<fork>>
    autoCT --> DryPumpCTon : Dry Pump CT Manual
    autoCT -->  [*]
    state DryPumpCTon <<join>>
'    : p(DT)  < 5 mBar

'    CheckPressuresLV -> StartDryPumpST : Press(DT)  < 500 mBar
    DryPumpCTon -> [*]  :  p(CT) < 100mBar

}

StartDryPumpCT -> StartDryPumpST

state StartDryPumpST {
    [*] -> DryPumpSTon 
    state DryPumpSTon #green
    DryPumpSTon -> [*]  :  p(DT) < 5mBar\np(CT,ST)  <  1e-2 mBar

}
StartDryPumpST -down-> OpenValvesPost : 50 sec

state "(Re)Open GT Valves" as OpenValvesPost {
    [*] -> CTSTGvOn
    CTSTGvOn -> STDTGvOn
    STDTGvOn -> [*]
}
OpenValvesPost -left-> CheckValves

state CheckValves { 
    [*] --> checkCTSTGateVal
    checkCTSTGateVal -> checkSTDTGateVal
    checkSTDTGateVal -> [*]
}

CheckValves -down-> CheckPressures

state CheckPressures

CheckPressures -> [*]  :  p(DT) < 5mBar\np(CT,ST)  <  1e-2 mBar
@enduml

