# vim: sta:et:sw=4:ts=4:sts=4
#
# Project       : ESTHER Vacuum slow Control
#
# File          : 
# Description   : Records for  Control
#
##
# Author        : Bernardo Carvalho (IPFN-IST)
#
# Copyright (c) : (IPFN-IST)
# Created 26-May-2022
#
##
#record(ai, "$(P)aiExample") {
#    field(DESC, "temp ai PV")
#}
record(mbbo, "$(P)$(R)OPSTATE") {
    field(DESC, "Vacuum Sequence State")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(SVVL, "7")
    field(EIVL, "8")
    field(NIVL, "9")
    field(TEVL, "10")
    field(ELVL, "11")
#    field(TVVL, "12")
    field(ZRST, "Stopped")
    field(ONST, "Idle")
    field(TWST, "ManualOperation")
    field(THST, "StartingLowVacuum")
    field(FRST, "LowVacuum")
    field(FVST, "StoppingLowVacuum")
    field(SXST, "StartingHighVacuum")
    field(SVST, "HighVacuum")
    field(EIST, "StoppingHighVacuum")
    field(NIST, "StartingShot")
    field(TEST, "ShotReady")
    field(ELST, "Emergency")
    field(FLNK, "$(P)$(R)OPCALCSTATE")
#    field(VAL, "0")
    #info(autosaveFields, "VAL")
#    field(PINI, "YES")
}
record(mbbo, "$(P)$(R)LAST-OPSTATE") {
    field(DESC, "Last Vacuum Sequence State")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(SVVL, "7")
    field(EIVL, "8")
    field(NIVL, "9")
    field(TEVL, "10")
    field(ELVL, "11")
#    field(TVVL, "12")
    field(ZRST, "Stopped")
    field(ONST, "Idle")
    field(TWST, "ManualOperation")
    field(THST, "StartingLowVacuum")
    field(FRST, "LowVacuum")
    field(FVST, "StoppingLowVacuum")
    field(SXST, "StartingHighVacuum")
    field(SVST, "HighVacuum")
    field(EIST, "StoppingHighVacuum")
    field(NIST, "StartingShot")
    field(TEST, "ShotReady")
    field(ELST, "Emergency")
#    field(EIST, "UPSEmergency")
    info(autosaveFields, "VAL")
}

record(mbbo, "$(P)$(R)Idle-SubState") {
    field(DESC, "Idle Sequence Sub-State")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(SVVL, "7")
    field(EIVL, "8")
    field(NIVL, "9")
    field(ZRST, "Inactive")
    field(ONST, "CheckManual")
    field(TWST, "OpenArms")
    field(THST, "OpenValves")
    field(FRST, "CheckValves")
    field(FVST, "None")
    field(SXST, "None")
    field(SVST, "None")
    field(EIST, "None")
    field(NIST, "End")
    field(VAL, "0")
    #info(autosaveFields, "VAL")
   # field(PINI, "YES")
}
record(mbbo, "$(P)$(R)StartingLV-SubState") {
    field(DESC, "StartingLowVacuum Sequence Sub-State")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(SVVL, "7")
    field(EIVL, "8")
    field(NIVL, "9")
    #field(TEVL, "10")
    field(ZRST, "Inactive")
    field(ONST, "OpenValvesPre")
    field(TWST, "CheckValvesPre")
    field(THST, "StartDryPump_DT")
    field(FRST, "StartDryPump_CT")
    field(FVST, "StartDryPump_ST")
    field(SXST, "OpenValvesPost")
    field(SVST, "CheckValvesPost")
    field(EIST, "CheckPressure")
    field(NIST, "End")
    field(VAL, "0")
}
record(mbbo, "$(P)$(R)StoppingLV-SubState") {
    field(DESC, "StoppingLowVacuum Sequence Sub-State")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(SVVL, "7")
    field(EIVL, "8")
    field(NIVL, "9")
    field(ZRST, "Inactive")
    field(ONST, "CheckValves")
    field(TWST, "None")
    field(THST, "None")
    field(FRST, "None")
    field(FVST, "None")
    field(SXST, "None")
    field(SVST, "None")
    field(EIST, "None")
    field(NIST, "End")
    field(VAL, "0")
   # field(PINI, "YES")
}
record(mbbo, "$(P)$(R)StartingHV-SubState") {
    field(DESC, "StartingHighVacuum Sequence Sub-State")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(SVVL, "7")
    field(EIVL, "8")
    field(NIVL, "9")
    field(ZRST, "Inactive")
    field(ONST, "CheckPressure")
    field(TWST, "CheckPumpsLevit")
    field(THST, "CheckPumpsAccel")
    field(FRST, "CheckPumpsNormal")
    field(FVST, "CheckHvPressure")
    field(SXST, "None")
    field(SVST, "None")
    field(EIST, "None")
    field(NIST, "End")
    field(VAL, "0")
}
record(mbbo, "$(P)$(R)StoppingHV-SubState") {
    field(DESC, "StoppingHighVacuum Sequence Sub-State")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(SVVL, "7")
#    field(EIVL, "8")
    field(NIVL, "9")
    field(ZRST, "Inactive")
    field(ONST, "CheckPumpsDecel")
    field(TWST, "CloseHvaValves")
    field(THST, "CheckHvaValves")
    field(FRST, "CheckPumpsLevit")
    field(FVST, "None")
    field(SXST, "None")
    field(SVST, "None")
    field(NIST, "End")
    field(VAL, "0")
}
record(mbbo, "$(P)$(R)StartingShot-SubState") {
    field(DESC, "StartingShot Sub-State")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(SVVL, "7")
    field(EIVL, "8")
    field(NIVL, "9")
    field(ZRST, "Inactive")
    field(ONST, "CloseArms")
    field(TWST, "CloseValves")
    field(THST, "None")
    field(FRST, "CheckPumpsNormal")
    field(FVST, "CheckHvPressure")
    field(SXST, "None")
    field(SVST, "None")
    field(EIST, "None")
    field(NIST, "End")
    field(VAL, "0")
}
record(mbbo, "$(P)$(R)CT-Vacuum-SubState") {
    field(DESC, "CT Vacuum Sequence SubState M")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(ZRST, "Stopped")
    field(ONST, "Idle")
    field(TWST, "ManualOperation")
    field(THST, "StartingLowVacuum")
    field(FRST, "LowVacuum")
    field(FVST, "StoppingLowVacuum")
    field(SXST, "Emergency")
    field(VAL, "0")
    #info(autosaveFields, "VAL")
}
record(mbbo, "$(P)$(R)DT-Vacuum-SubState") {
    field(DESC, "DT Vacuum Sequence SubState M")
    field(ZRVL, "0")
    field(ONVL, "1")
    field(TWVL, "2")
    field(THVL, "3")
    field(FRVL, "4")
    field(FVVL, "5")
    field(SXVL, "6")
    field(ZRST, "Stopped")
    field(ONST, "Idle")
    field(TWST, "ManualOperation")
    field(THST, "StartingLowVacuum")
    field(FRST, "LowVacuum")
    field(FVST, "StoppingLowVacuum")
    field(SXST, "Emergency")
    field(VAL, "0")
}
# record for bit leds
record(calc, "$(P)$(R)OPCALCSTATE") {
    field(DESC, "Pulse Calculated State")
    field(CALC,"2^A")
    #field(SCAN,"1 second")
    field(INPA,"$(P)$(R)OPSTATE.VAL NPP NMS")
}

record(bo, "$(P)$(R)START-REQ") {
    field(DESC, "Pulse Sequence Start/Continue")
    field(VAL, "0")
    field(PINI, "YES")
    field(ZNAM, "Push to Start")
    field(ONAM, "START")
}
record(bo, "$(P)$(R)STOP-REQ") {
    info(autosaveFields, "VAL")
    field(DESC, "Pulse Sequence Stop")
    field(VAL, "0")
    field(PINI, "YES")
    field(ZNAM, "Push to Stop")
    field(ONAM, "STOP")
}
#record(ao, "$(P)$(R)Hidraulic-Pressure") {
#    field(DESC, "Hidraulic-Pressure")
#    field(HOPR, "250.0")
#    field(LOPR, "0.0")
#    field(LOW, "20.0")
#    field(LSV, "MINOR")
#    field(LOLO, "10.0")
#    field(LLSV, "MAJOR")
#    field(EGU, "Bar")
#    field(VAL, "0.0")
#}
record(bo, "$(P)$(R)Water-Pump") {
    field(DESC, "Water Colling Pump")
    field(ZNAM, "Off")
    field(ONAM, "On")
    #field(VAL, "0")
}
# TODO change this to S7
#record(bo, "$(P)$(R)Turbo-Fans") {
#    field(DESC, "Maglev Turbos Fans")
#    field(ZNAM, "Off")
#    field(ZSV, "MINOR")
#    field(ONAM, "On")
    #field(VAL, "0")
#    info(autosaveFields, "VAL")
#}
record(bo, "$(P)$(R)Auto-Mode") {
    info(autosaveFields, "VAL")
    field(DESC, "Sequence Manual/Auto")
    field(ZNAM, "Supervisory")
    field(ONAM, "Auto")
}
record(bo, "$(P)$(R)Auto-Vacuum") {
    info(autosaveFields, "VAL")
    field(DESC, "Sequence Auto LV->HV /HV->LV")
    field(ZNAM, "Starting")
    field(ONAM, "Stopping")
}
record(bo, "$(P)$(R)CT-Auto-Enable") {
    field(DESC, "CT Vacuum Auto Mode Enable")
    field(ZNAM, "Off")
    field(ONAM, "On")
    info(autosaveFields, "VAL")
}
record(bo, "$(P)$(R)DT-Auto-Enable") {
    field(DESC, "DT Vacuum Auto Mode Enable")
    field(ZNAM, "Off")
    field(ONAM, "On")
    info(autosaveFields, "VAL")
}
record(calc, "$(P)$(R)COUNTUP") {
    field(DESC, "Counter Increment")
    field(INPA,"$(P)$(R)COUNTUP")
    field(DISA,"1")
    field(SCAN,"1 second")
    field(CALC,"A+1")
    field(VAL, "160")
}

record(stringout, "$(P)$(R)TraceMessage") {
    info(autosaveFields, "VAL")
    field(DESC, "Trace Message from IOC")
    field(VAL, "Trace mode ON")
}
#record(ai, "$(P)$(R)Time") {
#    field(DESC, "Current Date and Time of the IOC")
#    field(SCAN, "1 second")
#    field(INP, "%s")
#}
record(stringin, "$(P)$(R)CurrentTime") {
    field(DESC, "Current Date and Time of the IOC")
    field(SCAN, "1 second")
    field(DTYP, "Soft Timestamp")
    #field(PINI, "YES")
    field(INP, "@%d/%m/%Y %H:%M:%S")
}
# https://epics.anl.gov/tech-talk/2019/msg00486.php
record(stringin, "$(P)$(R)TimeOfDay") {
    field(DESC, "Current DTime of the IOC")
    field(SCAN, "10 second")
    field(DTYP, "Soft Timestamp")
    field(PINI, "YES")
    field(INP,"@%H:%M")
}
record(stringout,"$(P)$(R)Time2Reset"){
    field(DESC,"hour:min to rst Idle State")
    field(DTYP,"Soft Channel")
    field(VAL,"20:59")
    field(PINI,"YES")
}
record(scalcout,"$(P)$(R)ResetIdle"){
    field(DESC,"Reset Idle State")
    field(INPA,"$(P)$(R)HoldVacuum CP")
    field(INAA,"$(P)$(R)TimeOfDay CP")
    field(INBB,"$(P)$(R)Time2Reset CP")
    field(CALC,"((A==0) && (AA=BB))?1:0")
}
record(bo, "$(P)$(R)HoldVacuum") {
    # info(autosaveFields, "VAL")
    field(DESC, "Command to Hold Vacuum on Idle State")
    field(VAL, "0")
    field(PINI, "YES")
    field(ZNAM, "OFF")
    field(ONAM, "HOLD")
}
